package com.zhh.handsome.demo1;

public class 临界区和竞态条件 {
    static final Object lock = new Object();
    public static void main(String[] args) {


        /*synchronized (lock){
            System.out.println("进入临界区");
            try {
                Thread.sleep(5000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }*/




       /* 一、临界区（Critical Section）：需要 “排队” 执行的代码段
                定义
        临界区是指一段访问共享资源的代码。由于共享资源（如全局变量、数据库、文件等）在多线程环境下可能被多个线程同时操作，为了保证数据的一致性，这段代码同一时间只能允许一个线程执行。

        简单说：临界区就是 “多个线程不能同时进” 的代码区域，目的是保护共享资源不被 “并发修改”。
        例子：用 “银行账户” 理解临界区
        假设两个线程同时给同一个银行账户转账（共享资源是账户余额）：

        java
                运行
// 共享资源：账户余额
        int balance = 1000;

// 线程1：转入100元
        void transfer1() {
            int temp = balance;   // 读取当前余额
            temp += 100;          // 计算新余额
            balance = temp;       // 更新余额
        }

// 线程2：转入200元
        void transfer2() {
            int temp = balance;   // 读取当前余额
            temp += 200;          // 计算新余额
            balance = temp;       // 更新余额
        }

        这里的transfer1()和transfer2()中，从 “读取余额” 到 “更新余额” 的整个过程（3 行代码）就是临界区—— 因为它们都在操作共享资源balance。如果两个线程同时执行这段代码，可能导致结果错误（后文会解释）。
        临界区的核心特点
        访问共享资源：临界区必须包含对 “共享资源” 的操作（否则无需限制）。
        互斥执行：同一时间只能有一个线程进入临界区（需要通过锁、信号量等同步机制实现）。
        范围明确：临界区的范围应尽可能小（只包含必要的共享资源操作），否则会降低并发效率。
        二、竞态条件（Race Condition）：“抢资源” 导致的结果混乱
                定义
        竞态条件是指：当多个线程同时进入临界区，且操作结果依赖于线程执行的 “顺序” 时，导致最终结果不确定的现象。

        简单说：竞态条件是一种 “错误”，它的本质是 “多个线程在临界区无序执行，导致共享资源状态混乱”。
        例子：用 “银行转账” 看竞态条件的危害
        延续上面的银行账户例子，假设初始余额balance=1000，线程 1 和线程 2 同时执行转账：

        正常预期结果：1000 + 100 + 200 = 1300。

        但实际可能发生：

        线程 1 读取balance=1000，暂时让出 CPU；
        线程 2 读取balance=1000（此时线程 1 还没更新）；
        线程 1 计算temp=1100，更新balance=1100；
        线程 2 计算temp=1200，更新balance=1200（覆盖了线程 1 的结果）。

        最终余额 = 1200（错误），这就是竞态条件导致的结果 —— 因为两个线程在临界区的执行顺序打乱了，导致共享资源被错误修改。
        竞态条件的核心特点
        多线程并发：必须有多个线程同时访问临界区。
        依赖执行顺序：结果正确性依赖于线程执行的 “先后顺序”（顺序不同，结果不同）。
        结果不确定：最终结果可能不符合预期，且每次运行可能不同。   */
    }
}
